@using Sitecore.Globalization;
@using Sitecore.Data.Items;
@using Glass.Mapper.Sc;
@using Glass.Mapper.Sc.Web.Mvc;
@using Sitecore.Mvc.Presentation;
@using DEWAXP.Feature.Search.Models;
@using Sitecore.Mvc
@using DEWAXP.Foundation.Content
@using Categories = DEWAXP.Feature.Search.Models.Categories;
@model InstantSearchViewModel

@{
    var _lang = Sitecore.Context.Language.CultureInfo.TextInfo.IsRightToLeft ? "ar-AE" : "en";
    var catType = (int)Model.CurrentCategory;
    var pg_No = !string.IsNullOrEmpty(Request.QueryString["page"]) ? Request.QueryString["page"].ToString() : "1";

    if (Request.QueryString["category"] != null && Request.QueryString["category"].ToString() == "0")
    {
        Model.CurrentCategory = Categories.All;
    }

}
<style>
    .m39-modal--feedback .form-field__charcount + .parsley-errors-list {
        margin-top: 0px
    }

    .m39-modal.m39-modal--feedback .m39-modal__content {
        display: flex;
        flex-direction: column;
    }

    .m39-modal.m39-modal--feedback .m39-modal__container .m39-modal__dialog {
        max-height: 400px
    }

    .m39-modal.m39-modal--feedback #formfeedback {
        margin-top: auto;
        margin-bottom: auto
    }
</style>

<div class="" data-journey="j158-search-results">
    <div class="box j158-search-results">
        <div class="j158-search-results--tabrow">
            <div class="grid">
                <div class="grid__row grid__row--tight mb0">
                    <div class="grid__column grid__column--12 p0">
                        <ul class="j158-search-results--tablist">
                            <li class="j158-search-results--tab @Html.Raw(Model.CurrentCategory == Categories.All ? "active" : "")" id="t-all">
                                <a href="#" class="j158-search-results--tablink"> @Translate.Text("All")</a>
                            </li>
                            <li class="j158-search-results--tab @Html.Raw(Model.CurrentCategory == Categories.Services ? "active" : "") @Html.Raw(Model.ServicesCount == 0 ? "hidden" : "")" id="t-service">
                                <a href="#" class="j158-search-results--tablink"> @Translate.Text("m31_services")</a>
                            </li>
                            <li class="j158-search-results--tab @Html.Raw(Model.CurrentCategory == Categories.Content ? "active" : "") @Html.Raw(Model.ContentCount == 0 ? "hidden" : "")" id="t-content">
                                <a href="#" class="j158-search-results--tablink"> @Translate.Text("m31_contents")</a>
                            </li>
                            <li class="j158-search-results--tab @Html.Raw(Model.CurrentCategory == Categories.News ? "active" : "") @Html.Raw(Model.NewsCount == 0  ? "hidden" : "")" id="t-media">
                                <a href="#" class="j158-search-results--tablink"> @Translate.Text("m31_medianews")</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="j158-search-results--tabcontent">
            <div class="grid">
                <div class="grid__row">
                    <div class="grid__column grid__column--12">
                        <p class="total-result">@*@(string.Format(Translate.Text("m31_searchtook"), Model.TotalRecordsFound, Model.SearchTime))*@</p>
                    </div>
                </div>
            </div>
            <div class="grid">
                @if (Model.TotalRecordsFound > 0)
                {
                    if (Model.Services.Count > 0)
                    {
                <div class="grid__row j158-search-results--tabcontent-section t-service @Html.Raw((Model.CurrentCategory == Categories.Services || Model.CurrentCategory == Categories.All) ? "active" : "")">
                    <div class="grid__column grid__column--12">
                        <ul class="m31-search--dm_column">
                            <li class="m31-search--dm_title">
                                @Translate.Text("m31_services")
                            </li>
                            @foreach (var s in Model.Services.Take(Model.PageSize))
                                    {
                            <li class="m31-search--dm_item">
                                <a href="@s.Url" class="m31-search--dm_link">
                                    <div class="m31-search--dm_linkTitle">
                                        @(!string.IsNullOrEmpty(s.Title) ? s.Title.Replace("$name", string.Empty) : string.Empty)
                                    </div>
                                    <div class="m31-search--dm_linkDesc">
                                        @(!string.IsNullOrEmpty(s.Description) ? s.Description.Replace("$name", string.Empty) : string.Empty)
                                    </div>
                                </a>
                            </li>
                                    }

                        </ul>
                    </div>

                    @RenderPaging(Model.Services, Categories.Services, 1)

                    <div class="grid__column grid__column--12 allShowServices mb24" style="display:none">
                        <a href="@Html.Raw(Model.SearchResultPageUrl + "&page=" +(Model.CurrentPage+1)+ "&category=" + 1)" onclick="$(loader).show();" role="button" aria-label="@Translate.Text("m31_showmore")" class="button button--text button--next m34-pagination__button--next">@Translate.Text("m31_showmore")<span class="aria-only">@Translate.Text("m31_showmore") </span></a>
                    </div>

                </div>
                    }
                    if (Model.Content.Count > 0)
                    {
                <div class="grid__row j158-search-results--tabcontent-section t-content @Html.Raw((Model.CurrentCategory == Categories.Content || Model.CurrentCategory == Categories.All) ? "active" : "")">
                    <div class="grid__column grid__column--12">
                        <ul class="m31-search--dm_column">
                            <li class="m31-search--dm_title">
                                @Translate.Text("m31_contents")
                            </li>
                            @foreach (var s in Model.Content.Take(Model.PageSize))
                                    {
                            <li class="m31-search--dm_item">
                                <a href="@s.Url" class="m31-search--dm_link">
                                    <div class="m31-search--dm_linkTitle">
                                        @(!string.IsNullOrEmpty(s.Title) ? s.Title.Replace("$name", string.Empty) : string.Empty)
                                    </div>
                                    <div class="m31-search--dm_linkDesc">
                                        @(!string.IsNullOrEmpty(s.Description) ? s.Description.Replace("$name", string.Empty) : string.Empty)
                                    </div>
                                </a>
                            </li>
                                    }
                        </ul>
                    </div>
                    @RenderPaging(Model.Content, Categories.Content, 3)
                    <div class="grid__column grid__column--12 allShowContent mb24" style="display:none">
                        <a href="@Html.Raw(Model.SearchResultPageUrl + "&page=" +(Model.CurrentPage+1)+ "&category=" + 3)" onclick="$(loader).show();" role="button" aria-label="@Translate.Text("m31_showmore")" class="button button--text button--next m34-pagination__button--next">@Translate.Text("m31_showmore")<span class="aria-only">@Translate.Text("m31_showmore") </span></a>
                    </div>
                </div>
                    }
                    if (Model.News.Count > 0)
                    {
                <div class="grid__row j158-search-results--tabcontent-section t-media @Html.Raw((Model.CurrentCategory == Categories.News || Model.CurrentCategory == Categories.All) ? "active" : "")">
                    <div class="grid__column grid__column--12">
                        <ul class="m31-search--dm_column">
                            <li class="m31-search--dm_title">
                                @Translate.Text("m31_medianews")
                            </li>
                            @foreach (var s in Model.News.Take(Model.PageSize))
                                    {
                            <li class="m31-search--dm_item">
                                <a href="@s.Url" class="m31-search--dm_link">
                                    @if (!string.IsNullOrEmpty(s.Date))
                                                {
                                    <p><span class="inline-block teaser__date">@(s.Date)</span></p>
                                                }
                                    <div class="m31-search--dm_linkTitle">
                                        @(!string.IsNullOrEmpty(s.Title) ? s.Title.Replace("$name", string.Empty) : string.Empty)
                                    </div>
                                    <div class="m31-search--dm_linkDesc">
                                        @(!string.IsNullOrEmpty(s.Description) ? s.Description.Replace("$name", string.Empty) : string.Empty)
                                    </div>
                                </a>
                            </li>
                                    }
                        </ul>
                    </div>
                    @RenderPaging(Model.News, Categories.News, 2)

                    <div class="grid__column grid__column--12 allShowNews mb24" style="display:none">
                        <a href="@Html.Raw(Model.SearchResultPageUrl + "&page=" +(Model.CurrentPage+1)+ "&category=" + 2)" onclick="$(loader).show();" role="button" aria-label="@Translate.Text("m31_showmore")" class="button button--text button--next m34-pagination__button--next">@Translate.Text("m31_showmore")<span class="aria-only">@Translate.Text("m31_showmore") </span></a>
                    </div>

                </div>
                    }
                }
                else
                {
                <div class="grid__row">
                    <div class="grid__column--12">
                        <div class="m14-richtext">

                            <h4>
                                @Translate.Text("searchResults.NoResults") @Translate.Text("searchResults.For") - <span class="m63 - search - results__result - query"> @Model.Term </span>
                            </h4>

                            @Html.Raw(Translate.Text("No Result Detail"))
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
        <div class="box j158-search-results-feedback">
            <div class="grid">
                <div class="grid__row">
                    <div class="grid__column grid__column--12">
                        <div class="feedback-section">
                            <div class="feedback-block grid__row">
                                <div class="feedback-block-success" style="display:none">
                                    <div class="feedback-block-content">
                                        <h2 class="feedback-title"><span class="icon-tick"></span>@Translate.Text("m31_thankyoufeedback")</h2>
                                    </div>
                                </div>
                                <div class="feedback-block-static" style="display:block">
                                    <div class="feedback-block-content">
                                        <h2 class="feedback-title"> @Translate.Text("m31_aretheseresults")</h2>
                                        <h4 class="feedback-sub-title">@Translate.Text("m31_yourfeedbackhelps")</h4>
                                    </div>
                                    <div class="feedback-block-button">
                                        <button class="icon-thumbs-down"></button>
                                        <button class="icon-thumbs-up"></button>
                                    </div>
                                </div>
                            </div>

                            @if (Model.PopularSearchLinks != null && Model.PopularSearchLinks.Children.Any())
                            {
                            <div class="feedback-block grid__row">
                                <h2 class="feedback-title">@Translate.Text("m31_trendingsearch")</h2>
                                <ul class="feedback-form-list">
                                    @foreach (var item in Model.PopularSearchLinks.Children)
                                        {
                                    <li class="feedback-form-list-item icon-search">
                                        @Html.Glass().RenderLink(item, x => x.Link, attributes: new { target = "_self" })
                                    </li>
                                        }
                                </ul>
                            </div>
                            }
                            <div class="feedback-block grid__row">
                                <h2 class="feedback-title">@Translate.Text("m31_furthersupport")</h2>
                                @*@Html.Sitecore().Rendering(SitecoreRenderingIds.M74Expander, new { DataSource = DataSources.RammasDatasource })*@
                                <a href="/@_lang/rammas" class="m13-footer--floating_link m13-footer--floating_link--2 rammas">
                                    <img src="/~/media/Images/M74Expander/rammas_icon.ashx" class="tooltipstered">
                                    <div class="m13-footer--floating_rammastext mobile-hide">
                                        <div class="rammas-text-small">@Translate.Text("m31_chatwithr")</div>
                                        <div class="rammas-text-large">@Translate.Text("j120 Rammas")</div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="m39-modal m39-modal--feedback" data-component="m39-modal" id="modal_true">
            <button data-trigger="true" class="m39-modal__trigger hidden status_modal__trigger" id="_86qad514u_trigger" type="button" aria-controls="_86qad514u_content"></button>
            <div data-content="true" class="m39-modal__container" role="dialog" aria-expanded="false" id="_86qad514u_content" aria-labelledby="_86qad514u_trigger">
                <div class="m39-modal__dialog">
                    <div class="m39-modal__content" style="top: 123.797px;">
                        <div class="modal-feedback-title">
                            <span id="feedbackTitle"></span>
                            <button data-close="true" class="m39-modal__button--close" id="" aria-controls=""></button>
                        </div>
                        <form method="get" action="#" class="form" id="formfeedback" data-form="true" novalidate="">
                            <div class="form-field form-field--text form-field--textarea">
                                <label for="form-field-h16pumbyp" class="form-field__label">
                                    @Translate.Text("m31_tellusmore")
                                </label>
                                <span class="form-field__input-wrapper">
                                    <textarea class="form-field__input form-field__input--text form-field__input--textarea" maxlength="200" data-textarea="h16pumbyp" id="txFeedback" name="textarea" type="textarea" placeholder="@Translate.Text("m31_comments")" aria-describedby="description-for-h16pumbyp" data-parsley-errors-container="#description-for-h16pumbyp" required="" data-parsley-required-message="@Translate.Text("m31_fieldrequired")"></textarea>
                                </span>
                                <div id="description-for-h16pumbyp" class="form-field__messages">
                                    <p class="form-field__charcount"><span data-charcount="h16pumbyp">0</span>/200</p>
                                </div>
                            </div>
                            <div class="form-field__button">
                                <button class="button button--outline skip" type="" id="btSkip">@Translate.Text("m31_skip")</button>
                                <button class="button button--primary submit" type="submit" id="btSubmit">@Translate.Text("m31_submit")</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="m39-modal__overlay" style="display: none;"></div>
        </div>
    </div>
</div>
<div class="mask search-mask"><div class="loader"></div></div>


@helper RenderPaging(List<SearchItem> model, Categories thisCategory, int categoryCode)
{
    int count = 1, pageCount = InstantSearchViewModel.GetCategoryPageCount(Model, thisCategory);
    if (pageCount > 1)
    {
<div class="grid__column grid__column--12 allHide">
    <div class="m34-pagination m34-pagination-full">
        <div class="m34-pagination__content">
            @if (thisCategory == Model.CurrentCategory && Model.CurrentPage > 1)
                    {
            <a href="@Html.Raw(Model.SearchResultPageUrl+"&page="+(Model.CurrentPage-1)+"&category="+ categoryCode)" onclick="$(loader).show();" role="button" aria-label="@Translate.Text("m31_previous")" class="button button--text button--back m34-pagination__button--prev">@Translate.Text("m31_previous")<span class="aria-only">@Translate.Text("m31_previous") </span></a>
                    }
                    else
                    {
            <a href="#" role="button" aria-label="@Translate.Text("m31_previous")" class="button button--text button--back m34-pagination__button--prev hidden" disabled="disabled">@Translate.Text("m31_previous")<span class="aria-only"> @Translate.Text("m31_previous") </span></a>
                    }

            <span class="m34-pagination_center">
                @Html.Raw(Translate.Text("m31_page") + " " + Model.CurrentPage + " " + Translate.Text("of") + " " + pageCount)
            </span>

            @if (thisCategory == Model.CurrentCategory && Model.CurrentPage == pageCount)
                    {
            <a href="#" role="button" aria-label="@Translate.Text("m31_next")" class="button button--text button--next m34-pagination__button--next hidden" disabled="disabled">@Translate.Text("m31_next")<span class="aria-only">@Translate.Text("m31_next") </span></a>
                    }
                    else
                    {
            <a href="@Html.Raw(Model.SearchResultPageUrl + "&page=" +(Model.CurrentPage+1)+ "&category=" + categoryCode)" onclick="$(loader).show();" role="button" aria-label="@Translate.Text("m31_next")" class="button button--text button--next m34-pagination__button--next">@Translate.Text("m31_next")<span class="aria-only">@Translate.Text("m31_next") </span></a>
                    }
        </div>
    </div>



</div>
    }
}

<script type="text/javascript">

    var didUfind = true;
    var isSkip = false;

    jQuery(document).on("click", ".icon-thumbs-up", function (e) {
        didUfind = true;

        $('#feedbackTitle').html('@Translate.Text("m31_thankyou")');

    });
    jQuery(document).on("click", ".icon-thumbs-down", function (e) {
        didUfind = false;
        $('#feedbackTitle').html('@Translate.Text("m31_Nothankyou")');

    });




    jQuery(document).ready(function ($) {
            jQuery(document).on("click", "#btSkip", function (e) {
            isSkip = true; SendFeedback(); jQuery("#btSubmit").prop("disabled", true);
            jQuery("#btSkip").prop("disabled", true);

                setTotalValues();

        });


        jQuery(document).on("submit", "#formfeedback", function (e) {
            isSkip = false;
            $('.m39-modal__button--close').trigger("click");
            e.preventDefault();
            SendFeedback();
            jQuery("#btSubmit").prop("disabled", true);
            jQuery("#btSkip").prop("disabled", true);
            return false;
        });




        if (@catType == 0) {
            var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.ServicesCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
            //$('.total-result').html(_countVal + "<br>" + @Model.SolrSearchTime);
        }
        else if (@catType == 2) {

            var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.ContentCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
            //$('.total-result').html(_countVal + "<br>" + @Model.SolrSearchTime);
        }
        else if (@catType == 1) {
              var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.NewsCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
            //$('.total-result').html(_countVal + "<br>" + @Model.SolrSearchTime);
        }
        else if (@catType == 3) {
              var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.TotalRecordsFound, Model.SearchTime))';
            $('.total-result').html(_countVal);
           //$('.total-result').html(_countVal + "<br>" + @Model.SolrSearchTime);

             $('.allHide').css('display', 'none');

             if (@InstantSearchViewModel.GetCategoryPageCount(Model, Categories.Services) > 1) {
                 $('.allShowServices').css('display', 'inline');
             }

             if (@InstantSearchViewModel.GetCategoryPageCount(Model, Categories.Content) > 1) {
                 $('.allShowContent').css('display', 'inline');
             }

              if (@InstantSearchViewModel.GetCategoryPageCount(Model, Categories.News) > 1) {
                 $('.allShowNews').css('display', 'inline');
             }

        }


         $('#t-all').click(function (e) {
                var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.TotalRecordsFound, Model.SearchTime))';
             $('.total-result').html(_countVal);

             $('.allHide').css('display', 'none');

             if (@InstantSearchViewModel.GetCategoryPageCount(Model, Categories.Services) > 1) {
                 $('.allShowServices').css('display', 'inline');
             }

             if (@InstantSearchViewModel.GetCategoryPageCount(Model, Categories.Content) > 1) {
                 $('.allShowContent').css('display', 'inline');
             }

              if (@InstantSearchViewModel.GetCategoryPageCount(Model, Categories.News) > 1) {
                 $('.allShowNews').css('display', 'inline');
             }
             redirectForPaging('0', true);

            });

        $('#t-service').click(function (e) {
                var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.ServicesCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
            $('.allShowServices').css('display', 'none');
            $('.allHide').css('display', 'inline');
            redirectForPaging('1', false);

            });
        $('#t-content').click(function (e) {
                var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.ContentCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
            $('.allShowContent').css('display', 'none');
            $('.allHide').css('display', 'inline');
            redirectForPaging('3', false);

            });
        $('#t-media').click(function (e) {
                var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.NewsCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
            $('.allShowNews').css('display', 'none');
            $('.allHide').css('display', 'inline');
            redirectForPaging('2', false);
            });

    });

        function redirectForPaging(sCat, isAllClicked) {


            var finalURL = window.location.href.toLowerCase();

            if (sCat == '0' && isAllClicked) {
                if (finalURL.indexOf("&page=1") < 0) {
                    for (var i = 0; i <= 3; i++) {
                        finalURL = finalURL.toLowerCase().replace("&category=" + i, "");
						//finalURL = finalURL.toLowerCase().replace("&page="+i,"");
                    }
                    if (getUrlVars()["page"] != '')
                        finalURL = finalURL.toLowerCase().replace("&page=" + getUrlVars()["page"], "").replace("?page=" + getUrlVars()["page"] + "&","?");

                    finalURL = finalURL.toLowerCase().replace("#", "");
                    finalURL += "&page=1&category=0";
                    window.location.href = finalURL;
                    $('.search-mask').addClass('mask-show');
                }
            }
            else {
                if (finalURL.indexOf("&page=1") < 0) {
                    for (var i = 0; i <= 3; i++) {
                        finalURL = finalURL.toLowerCase().replace("&category=" + i, "");
                        //finalURL = finalURL.toLowerCase().replace("&page="+i,"");
                    }
                    if (getUrlVars()["page"] != '')
                       finalURL = finalURL.toLowerCase().replace("&page=" + getUrlVars()["page"], "").replace("?page=" + getUrlVars()["page"] + "&","?");

                    finalURL = finalURL.toLowerCase().replace("#", "");
                    finalURL += "&page=1&category=" + sCat;

                    window.location.href = finalURL;
                    $('.search-mask').addClass('mask-show');
                }
            }
        }

		function getUrlVars()
		{
			var vars = [], hash;
			var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
			for(var i = 0; i < hashes.length; i++)
			{
				hash = hashes[i].split('=');
				vars.push(hash[0]);
				vars[hash[0]] = hash[1];
			}
			return vars;
		}

		function setTotalValues()
		{
			 if (@catType == 0) {
            var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.ServicesCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
        }
        else if (@catType == 2) {

            var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.ContentCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
        }
        else if (@catType == 1) {
              var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.NewsCount, Model.SearchTime))';
            $('.total-result').html(_countVal);
            }
         else if (@catType == 3) {
              var _countVal = '@(string.Format(Translate.Text("m31_searchtook"), Model.TotalRecordsFound, Model.SearchTime))';
            $('.total-result').html(_countVal);
        }

		}

    function SendFeedback()
    {

        var url = '@Url.Action("SaveFeedback")';

        var data = { term: "@Model.Term", didUFind: didUfind, feedback: isSkip == true ? '' : $("#txFeedback").val(), "__RequestVerificationToken": GetAFToken() };

        try {
            jQuery.ajax({
                url: url, data: data,
                beforeSend: function () {
                    $(loader).show();
                },
                complete: function () {
                    $(loader).hide();
                },
                dataType: "json",
                type: 'POST',
                success: function (res) {
                    jQuery(".feedback-block-static").hide();
                    jQuery(".feedback-block-success").show();
                },
                fail: function (error) {
                    console.log(error);
                    $(loader).hide();
                }
            });

        } catch (error) {
            console.log(error);
            $(loader).hide();
        }
    }

    function GetAFToken() {
        return jQuery('input[name="__RequestVerificationToken"]').val()
    }
</script>
