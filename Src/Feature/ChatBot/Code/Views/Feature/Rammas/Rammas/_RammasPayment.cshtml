@using Sitecore.Globalization
@using Sitecore.Mvc
@using DEWAXP.Foundation.Content
<div class="m66-preloader" id="loaderpayment">
    <div class="grid">
        <div class="grid__row">
            <div class="grid__column grid__column--12">
                <h2 class="text__section-subtitle"> @Translate.Text("RedirectingToPayment")</h2>
                <div class="loader"></div>
            </div>
        </div>
    </div>
</div>
<div class="grid__row hidden" id="errorpayment">
    <div class="grid__column grid__column--12">
        <div class="m40-status-message m40-status-message--error icon icon-caution" data-component="m40-status-message">
            <div class="m40-status-message__title icon--error">@Sitecore.Globalization.Translate.Text(DictionaryKeys.Global.SubmissionError)</div>
            <div class="m40-status-message__text">@Translate.Text("Error")</div>
        </div>
    </div>
</div>
<form class="form-horizontal" id="myForm" method="POST" action="">
    @Html.AntiForgeryToken()
    <input type="hidden" name="dewatoken" />
    <input type="hidden" name="u" />
</form>

<script>
    var cId = getParameterByName("conversationId");
    if (cId != null && cId != "") {
        var url = "/api/RammasApi/RammasFetchBotState?conversationId=" + cId;
        jQuery.ajax({
            url: url,
            traditional: true,
            dataType: 'json',
            type: 'GET',
            success: function (response) {
                var isError = (response.Message != undefined && response.Message.length < 1);
                var isMIMError = (response && response.data && response.data.ErrorMessages.length > 0);
                if (isError || isMIMError) {
                    console.log(response)
                    jQuery("#loaderpayment").hide();
                    jQuery("#errorpayment").show();
                }
                else if (response && response.data) {
                    jQuery('input[name="dewatoken"]').val(response.data.PayPostModel.dewatoken);
                    jQuery('input[name="u"]').val(response.data.PayPostModel.u);
                    document.getElementById("myForm").action = response.data.PayPostModel.PaymentUrl;
                    document.getElementById("myForm").submit();
                }
                //console.log("test");
            }

        });
    }
    else {
        jQuery("#loaderpayment").hide();
        jQuery("#errorpayment").show();
    }
</script>