@using DEWAXP.Foundation.Content
@using DEWAXP.Foundation.Helpers
@using DEWAXP.Feature.Partner.Models.CorporatePartnership
@model List<SubmittedRequest>
@using Sitecore.Mvc
@using Sitecore.Globalization
@using Sitecorex = Sitecore
<div class="grid">
    @Html.Sitecore().Placeholder("placeholder-back")
    @if (Model != null && Model.Count > 0)
    {
        <div class="m66-preloader j1-CP--loader hidden">
            <div class="grid">

                <div class="grid__row">
                    <div class="grid__column grid__column--12">
                        <h2 class="text__section-subtitle">@Translate.Text("J100.Pleasewait")</h2>
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid__row">
            <div class="grid__column grid__column--12">
                <div class="m18-teaser" data-component="m18-teaser">
                    <div class="m18-teaser--heading_wrapper">
                        <span class="m18-teaser--title">@Translate.Text("cpportal.Submitted Requests")</span>
                        <span class="m18-teaser--count" dir="ltr"><span class="m18-teaser--count_catch"></span> @Translate.Text("cpportal.Total")</span>
                    </div>
                    @foreach (SubmittedRequest req in Model)
                    {
                        <div class="m18-teaser--item submitted-request">
                            @if (!string.IsNullOrWhiteSpace(req.Date) && !string.IsNullOrWhiteSpace(req.Month))
                            {
                                <div class="m18-teaser__date">
                                    <div class="m18-teaser__date-day">
                                        @req.Date
                                    </div>
                                    <div class="m18-teaser__date-month">
                                        @DEWAXP.Foundation.Content.Helpers.DateHelper.ConvertLocalDateFormate(req.Month, "MMM yyyy", "MMM yyyy")
                                    </div>
                                </div>
                            }
                            <div class="m18-teaser--detail_wrapper">
                                <div class="m18-teaser--detail_heading">
                                    <div class="m18-teaser--detail_type requesttype">@Translate.Text(req.RequestType)</div>
                                </div>
                                <div class="m18-teaser--detail_title requestname" data-event-efolderid="@req.Efolderid"
                                     data-event-cancelledrequest="@req.CancelledRequest"
                                     data-event-location="@req.Location" data-event-tolist="@req.ToList"
                                     data-event-fromdate="@req.FromDate" data-event-todate="@req.ToDate" data-event-fromtime="@req.FromTime" data-event-totime="@req.ToTime"
                                     data-event-message="@req.Message">@req.Eventname</div>
                                    <div class="m18-teaser--detail_itin_wrapper">
                                        <div class="m18-teaser--detail_itin">
                                            <img src="/Content/cp-content/images/m18time.png" alt="">
                                            <div class="m18-teaser--detail_itin-content">
                                                @req.FromTime - @req.ToTime
                                            </div>
                                        </div>
                                        <div class="m18-teaser--detail_itin">
                                            <img src="/Content/cp-content/images/m18pin.png" alt="">
                                            <div class="m18-teaser--detail_itin-content">
                                                @req.Location
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="m18-teaser--buttons">
                                    @if (!req.CancelledRequest)
                                    {
                                        <div class="button button--primary edit-submitted-request">@Translate.Text("cpportal.Edit Details")</div>
                                        <div class="button cancel-submitted-request">@Translate.Text("cpportal.cancel")</div>
                                    }
                                    else
                                    {
                                        <div class="button button--primary edit-submitted-request">@Translate.Text("cpportal.View Details")</div>
                                    }
                                </div>
                            </div>
                        }
                </div>
            </div>
        </div>
        <div class="m39-modal m39-modal--new m5-quick-services--event_modal" data-component="m39-modal" id="meetingrequest">
            <button data-trigger="true" class="m39-modal__trigger hidden" type="button" id="meetingrequest_trigger" aria-controls="meetingrequest_content"></button>
            <div data-content="true" class="m39-modal__container" role="dialog" aria-expanded="false" id="meetingrequest_content" aria-labelledby="meetingrequest_trigger">
                <div class="m39-modal__dialog">
                    @Html.Partial("~/Views/Feature/Partner/CorporatePartnership/_MeetingRequest.cshtml", false)
                </div>
            </div>
            <div class="m39-modal__overlay"> </div>
        </div>
        <div class="m39-modal m39-modal--new m5-quick-services--event_modal m5-quick-services--mail_success" data-component="m39-modal" id="cancelrequest">
            <button data-trigger="true" class="m39-modal__trigger hidden" type="button" id="cancelrequest_trigger" aria-controls="cancelrequest_content"></button>
            <div data-content="true" class="m39-modal__container" role="dialog" aria-expanded="false" id="cancelrequest_content" aria-labelledby="cancelrequest_trigger">
                <div class="m39-modal__dialog">
                    <div class="m39-modal__header">
                        <div class="m39-modal__title">@Translate.Text("cpportal.Submitted request")</div>
                    </div>
                    <div class="m39-modal__content" style="top: 31px;">
                        <div class="grid__row cancelcontent">
                            @Translate.Text("cpportal.Do you really need to cancel this submitted request?")
                        </div>
                        <div class="grid__row">
                            <input type="hidden" name="cancelfolderid" id="cancelfolderid" value="" />
                            <div class="button m39-m12-no">@Translate.Text("cpportal.NO")</div>
                            <div class="button button--primary m39-m12-cancelrequest">@Translate.Text("cpportal.YES")</div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <script>
            docReady(function () {
                jQuery(".edit-submitted-request").on('click', function (event) {
                    var $bParent = $(this).closest('.submitted-request');
                    var requesttype = $bParent.find('.requesttype').html(),
                        eventname = $bParent.find('.requestname').html(),
                        efolderid = $bParent.find('.requestname').data('event-efolderid').toString(),
                        location = $bParent.find('.requestname').data('event-location').toString(),
                        tolist = $bParent.find('.requestname').data('event-tolist').toString(),
                        fromdate = $bParent.find('.requestname').data('event-fromdate').toString(),
                        todate = $bParent.find('.requestname').data('event-todate').toString(),
                        fromtime = $bParent.find('.requestname').data('event-fromtime').toString(),
                        totime = $bParent.find('.requestname').data('event-totime').toString(),
                        message = $bParent.find('.requestname').data('event-message').toString();
                    jQuery('.cancalleddiv').show();
                    cancelledrequest = $bParent.find('.requestname').data('event-cancelledrequest').toString();
                    jQuery('#meetingrequest').find('input[name=requesttype]').val(requesttype.trim());
                    jQuery('#meetingrequest').find('input[name=eventName]').val(eventname.trim());
                    jQuery('#meetingrequest').find('input[name=location]').val(location.trim());
                    $arraytolist = tolist.split(';');
                    jQuery('#meetingrequest').find('#form-field-tolist1').html('');
                    if ($arraytolist.length > 0) {
                        $($arraytolist).each(function (i, obj) {
                            if (obj.length > 0) {
                                jQuery('#meetingrequest').find('#form-field-tolist1').prepend('<option selected="" value="' + obj + '">' + obj + '</option>');
                            }
                        });
                    }
                    if (cancelledrequest == "True") {
                        jQuery('.cancalleddiv').hide();
                    }
                    jQuery('#meetingrequest').find('input[name=updaterequest]').val(efolderid.trim());
                    jQuery('#meetingrequest').find('input[name=fromdate]').val(fromdate.trim());
                    jQuery('#meetingrequest').find('input[name=todate]').val(todate.trim());
                    jQuery('#meetingrequest').find('select[name=fromtime]').val(fromtime.trim());
                    jQuery('#meetingrequest').find('select[name=totime]').val(totime.trim());
                    jQuery('#meetingrequest').find('textarea[name=message1]').val(message.trim());
                    jQuery('#meetingrequest').find('.m39-modal__trigger').trigger('click');
                });
                jQuery("#meetingrequestcancel,.m39-m12-no").on('click', function (event) {
                    jQuery('#meetingrequest').find('.m39-modal__button--close').trigger('click');
                });
                jQuery(".cancel-submitted-request").on('click', function (event) {
                    var $bParent = $(this).closest('.submitted-request');
                    var efolderid = $bParent.find('.requestname').data('event-efolderid').toString();
                    jQuery('#cancelrequest').find('input[name=cancelfolderid]').val(efolderid.trim());
                    jQuery('#cancelrequest').find('.m39-modal__trigger').trigger('click');
                });
                jQuery(".m39-m12-cancelrequest").on('click', function (event) {
                    var url = "/api/sitecore/CorporatePartnership/CancelMeetingRequest";
                    jQuery.ajax({
                        url: url,
                        traditional: true,
                        data:
                            AddForgeryToken({
                                requestid: $('#cancelfolderid').val()
                            }, "form-meetingrequest"),
                        beforeSend: function () {
                            jQuery('.j1-CP--loader').show();
                            jQuery('.j1-CP--loader').css('top', $(window).scrollTop());
                        },
                        complete: function () {
                            jQuery('.j1-CP--loader').hide();
                        },
                        dataType: 'json',
                        type: 'POST',
                    }).done(function (response) {
                        window.location.reload();
                    });
                });
            });
        </script>
    }
    else
    {
        <div class="grid__row">
            <div class="grid__column grid__column--12">
                <p class="centered">
                    @Translate.Text("cpportal.There is no Submitted Request")
                </p>
            </div>
        </div>
    }
</div>