@using DEWAXP.Foundation.Integration.CorporatePortal
@using Sitecore.Mvc.Configuration
@using Sitecore.Globalization

@using (Html.BeginRouteForm(MvcSettings.SitecoreRouteName, FormMethod.Post, new { @class = "form static-form", @id = "form-composemessage", data_form = "true", enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()

    <div class="m39-modal__header">
        <div class="m39-modal__title">@Translate.Text("cpportal.Compose Message")</div>
        <a data-close="true" class="m39-modal__button--close" id="composemessage_close" aria-controls="composemessage_content"></a>
    </div>
    <div class="m39-modal__content" id="composemessage_content">
        <div class="grid__row">
            <div class="grid__column grid__column--12">
                <fieldset class="fieldset">
                    <legend class="legend-color">.</legend>
                    @*<div class="form-field form-field--select form-field--select-single">
                            <label for="form-field-tolist" class="form-field__label">
                                To
                            </label>
                            <span class="form-field__input-wrapper form-field__input-wrapper--select removePseudo">
                                <select class="m5-quick-services--mail_select form-field__input form-field__input--select form-field__input--select-full form-field__input--select2 select2-hidden-accessible"
                                        id="form-field-tolist" select2-isemail="true" name="division_linkage" multiple="" aria-describedby="description-for-tolist" data-parsley-errors-container="#description-for-tolist" placeholder="Send to" required="" data-parsley-required-message="This field is required" data-select2-id="form-field-tolist" tabindex="-1" aria-hidden="true" data-parsley-trigger="change"></select>
                            </span>
                            <div id="description-for-tolist" class="form-field__messages">
                            </div>
                        </div>*@

                    <div class="form-field form-field--text  ">
                        <label for="form-field-requestername_compose" class="form-field__label">
                            @Translate.Text("cpportal.requestername")
                        </label>
                        <span class="form-field__input-wrapper">
                            <input class="form-field__input form-field__input--text"
                                   id="form-field-requestername_compose"
                                   name="requestername_compose"
                                   type="text"
                                   maxlength="100"
                                   aria-describedby="description-for-requestername_compose"
                                   data-parsley-errors-container="#description-for-requestername_compose"
                                   required=""
                                   placeholder="@Translate.Text("cpportal.requesternameph")"
                                   data-parsley-required-message="@Translate.Text("cpportal.requesternamemsg")"
                                   data-parsley-trigger="focusout"
                                   data-parsley-id="14">
                        </span>
                        <div id="description-for-requestername_compose" class="form-field__messages">
                        </div>
                    </div>

                    <div class="form-field form-field--text ">
                        <label for="form-field-EmailAddress_compose" class="form-field__label">
                            @Translate.Text("cpportal.Emailaddress")
                        </label>
                        <label class="form-field__input-wrapper">
                            <input class="form-field__input form-field__input--text"
                                   id="form-field-emailaddress_compose"
                                   name="Emailaddress_compose"
                                   type="email"
                                   maxlength="50"
                                   aria-describedby="description-for-EmailAddress_compose"
                                   data-parsley-errors-container="#description-for-EmailAddress_compose"
                                   required=""
                                   placeholder="@Translate.Text("cpportal.Emailaddressph")"
                                   data-parsley-required-message="@Translate.Text("cpportal.Emailaddressmsg")"
                                   data-parsley-trigger="focusout"
                                   data-parsley-id="14">
                        </label>
                        <div id="description-for-EmailAddress_compose" class="form-field__messages">
                        </div>
                    </div>

                    <div class="form-field form-field--text  ">
                        <label for="form-field-subject_compose" class="form-field__label">
                            @Translate.Text("cpportal.Subject")
                        </label>
                        <span class="form-field__input-wrapper">
                            <input class="form-field__input form-field__input--text"
                                   id="form-field-subject_compose"
                                   name="subject_compose"
                                   type="text"
                                   maxlength="100"
                                   aria-describedby="description-for-subject_compose"
                                   data-parsley-errors-container="#description-for-subject_compose"
                                   required=""
                                   placeholder="@Translate.Text("cpportal.Subjectph")"
                                   data-parsley-required-message="@Translate.Text("cpportal.Subjectmsg")"
                                   data-parsley-trigger="focusout"
                                   data-parsley-id="14">
                        </span>
                        <div id="description-for-subject_compose" class="form-field__messages">
                        </div>
                    </div>
                    <div class="form-field form-field--text form-field--textarea">
                        <label for="form-field-message_compose" class="form-field__label">
                            @Translate.Text("cpportal.Message")
                        </label>
                        <span class="form-field__input-wrapper">
                            <textarea class="form-field__input form-field__input--text form-field__input--textarea"
                                      data-textarea="message_compose"
                                      id="form-field-message_compose"
                                      name="message_compose"
                                      type="textarea"
                                      maxlength="500"
                                      placeholder="@Translate.Text("cpportal.Messageph")"
                                      aria-describedby="description-for-message_compose"
                                      data-parsley-errors-container="#description-for-message_compose"
                                      required=""
                                      data-parsley-required-message="@Translate.Text("cpportal.Messagemsg")"
                                      data-parsley-id="22"></textarea>
                        </span>
                        <div id="description-for-message_compose" class="form-field__messages">
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
    <div class="m39-modal__footer">
        <div id="sendbuttonmessage" class="button button--primary button--next" data-accountupdate="true" data-modal-confirm="true">@Translate.Text("cpportal.send")</div>
        <div class="button m5-quick-services--mail_cancel" id="composemessagecancel">@Translate.Text("cpportal.cancel")</div>
    </div>
}
<script>
    docReady(function () {
        jQuery("#sendbuttonmessage").off('click.send').on('click.send', function (event) {
            //event.preventDefault();
            //event.stopPropagation();
            if (jQuery("#form-composemessage").parsley().validate()) {
                //var tolisttext = [];
                //$('#form-field-tolist option:selected').each(function () {
                //    tolisttext.push($(this).val());
                //});
                //var $tolist = tolisttext.join("; ");
                var url = "/api/sitecore/CorporatePartnership/ComposeMessage";
                jQuery.ajax({
                    url: url,
                    traditional: true,
                    data:
                        AddForgeryToken({
                            requestername: jQuery('#form-composemessage').find('#form-field-requestername_compose').val(),
                            requesteremail: jQuery('#form-composemessage').find('#form-field-emailaddress_compose').val(),
                            //tolist: $tolist,
                            subject: jQuery('#form-composemessage').find('#form-field-subject_compose').val(),
                            message: jQuery('#form-composemessage').find('#form-field-message_compose').val()
                        }, "form-composemessage"),
                    beforeSend: function () {
                        jQuery('.j1-CP--loader').show();
                        jQuery('.j1-CP--loader').css('top', $(window).scrollTop());
                    },
                    complete: function () {
                        jQuery('.j1-CP--loader').hide();
                    },
                    dataType: 'json',
                    type: 'POST',
                }).done(function (response) {

                    if (response.status) {
                        jQuery('#successtitlemessage').html('@Translate.Text("cpportal.success title")');
                        jQuery('#successtextmessage').html('@Translate.Text("cpportal.success text")');
                        jQuery('#form-composemessage').find('#composemessagecancel').trigger('click');
                        jQuery('#successmodal').find('.m39-modal__trigger').trigger('click');
                        //console.log(response);
                    }
                    else {
                        if (response.islogin == undefined) {
                            jQuery('#successtitlemessage').html('@Translate.Text("cpportal.failure title")');
                            jQuery('#successtextmessage').html('@Translate.Text("cpportal.failure text")');
                            jQuery('#form-composemessage').find('#composemessagecancel').trigger('click');
                            jQuery('#successmodal').find('.m39-modal__trigger').trigger('click');
                        }
                        else {
                            window.location.reload();
                        }
                    }
                });
            }
        });
        var $success_modal = jQuery('.m5-quick-services--mail_success');

        $success_modal.find('.m5-quick-services--mail_success-close').on('click', function () {
            $success_modal.find('.m39-modal__button--close').click();
            window.location.reload();
        });
    });
</script>
