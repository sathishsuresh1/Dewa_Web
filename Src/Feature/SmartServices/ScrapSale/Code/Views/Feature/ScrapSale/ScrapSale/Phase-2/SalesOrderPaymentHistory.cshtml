@using Sitecore.Globalization;
@using DEWAXP.Foundation.Integration.CustomerSmartSalesSvc
@using DEWAXP.Foundation.Helpers
@using DEWAXP.Foundation.Content
@model DEWAXP.Feature.ScrapSale.Models.ScrapSale.SalesOrderPaymentHistoryModel


<div class="grid">
    <div class="grid__row">
        <div class="grid__column grid__column--12 grid__column--form">
            <div class="form-field form-field--select form-field--select-single ">
                <span class="form-field__input-wrapper form-field__input-wrapper--select">
                    <select class="form-field__input form-field__input--select form-field__input--select-full j131-scrap-sales_select"
                            id="form-field-8l4jhglg1"
                            name="select"
                            aria-describedby="description-for-8l4jhglg1"
                            data-parsley-errors-container="#description-for-8l4jhglg1">
                        @if (ViewBag.ReceiptsFilter != null && (List<SelectListItem>)ViewBag.ReceiptsFilter != null)
                        {
                            int i = 1;
                            foreach (var item in (List<SelectListItem>)ViewBag.ReceiptsFilter)
                            {
                                <option class="m82-payment-history--header_buttoni @(i==1?"m82-payment-history--header_buttona":string.Empty)" data-transaction="@item.Value">@item.Text</option>
                                i++;
                            }
                        }
                    </select>
                </span>
                <div id="description-for-8l4jhglg1" class="form-field__messages">
                </div>
            </div>
            <div id="transaction-history-placeholder" class="ajax-placeholder" style="min-height: 100px;">

                @*Sales Order Receipt*@
                @if (Model != null && Model.scrapOrdersDetailsList != null && Model.scrapOrdersDetailsList.scraporderslist != null && Model.scrapOrdersDetailsList.scraporderslist.Length > 0)
                {
                    foreach (salesOrderDetails item in Model.scrapOrdersDetailsList.scraporderslist)
                    {
                        <div class="transaction-history" data-transaction="sales" data-transaction-ref="@item.salesdocumentnumber">
                            <div class="transaction-history__item">
                                <div class="transaction-history__title">
                                    @Translate.Text("SS_PH_SalesOrderNo") - @item.salesdocumentnumber
                                </div>
                                <span class="transaction-history__detail-amount--bill">
                                    <span class="transaction-history__detail-item--content">@item.totalpaidamount @Translate.Text("AED")</span>
                                </span>
                                <ul class="transaction-history__detail">
                                    <li class="transaction-history__detail-item">
                                        <span class="transaction-history__detail-item--content">@Translate.Text("SS_BD_TenderNumber") @item.materialnumber</span>
                                    </li>
                                </ul>
                                @if (Model.scrapOrdersDetailsList.SOPaymentDetails != null && Model.scrapOrdersDetailsList.SOPaymentDetails.Where(x => x.salesdocumentnumber.Equals(item.salesdocumentnumber)).Any())
                                {
                                    <div class="m39-modal m39-modal--new j131-scrap-sales_modal" data-component="m39-modal" id="modal_true">
                                        <a data-trigger="true" class="button button--primary button--next button--very_small" href="@item.salesdocumentnumber" target="_blank">@Translate.Text("SS_PH_ViewReceipt")</a>
                                        <button data-trigger="true" class="m39-modal__trigger hidden" id="_sm7xs93q5_trigger" type="button" aria-controls="_sm7xs93q5_content">@Translate.Text("SS_PH_ModelTrigger")</button>
                                        <div data-content="true" class="m39-modal__container" role="dialog" aria-expanded="true" id="_sm7xs93q5_content" aria-labelledby="_sm7xs93q5_trigger">
                                            <div class="m39-modal__dialog">
                                                <div class="m39-modal__header">
                                                    <div class="m39-modal__title">@Translate.Text("SS_PH_SalesOrder") @item.salesdocumentnumber</div>
                                                    <a data-close="true" class="m39-modal__button--close" id="_sm7xs93q5_close" aria-controls="_sm7xs93q5_content">@Translate.Text("TH.Close")</a>
                                                    <div class="m39-modal__subtitle">@Translate.Text("SS_PH_Receipts")</div>
                                                </div>
                                                <div class="m39-modal__content">
                                                    @foreach (salesOrderPaymentList i in Model.scrapOrdersDetailsList.SOPaymentDetails.Where(x => x.salesdocumentnumber.Equals(item.salesdocumentnumber)))
                                                    {
                                                        <div class="m39-modal__content--list">
                                                            <div class="m39-modal__content--list_text">
                                                                <div class="m39-modal__content--list_texthead">@Translate.Text("SS_PH_Receipts") @i.accountingdocumentnumber</div>
                                                                <div class="m39-modal__content--list_textdate">@Translate.Text("SS_PH_Amount") @i.amount @Translate.Text("AED")</div>
                                                            </div>
                                                            <a href="javascript:void(0)" data-fyid="@(i.fiscalyear)" data-ccid="@(i.companycode)" data-adnid="@(i.accountingdocumentnumber)" data-sdnid="@(i.salesdocumentnumber)" class="button button--primary button--small m39-modal__content--list_button sosdocu-downloadbtn">@Translate.Text("SS_Download")</a>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        <div class="m39-modal__overlay" style="display: block;"> </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }

                @*EMD Payment History*@
                @if (Model != null && Model.emdList != null && Model.emdList.EMDlistdetails != null && Model.emdList.EMDlistdetails.Length > 0)
                {
                    foreach (emdListDetails item in Model.emdList.EMDlistdetails)
                    {
                        <div class="transaction-history" data-transaction="emd" data-transaction-ref="@item.accountingdocumentnumber">
                            <div class="transaction-history__item">
                                <div class="transaction-history__title">
                                    @Translate.Text("SS_PH_EmdReceipt") - @item.tenderfeereferencenumber
                                </div>
                                <span class="transaction-history__detail-amount--bill">
                                    <span class="transaction-history__detail-item--content">@item.amount @Translate.Text("AED")</span>
                                </span>
                                <ul class="transaction-history__detail">
                                    <li class="transaction-history__detail-item">
                                        <span class="transaction-history__detail-item--content">@Translate.Text("SS_BD_TenderNumber") @item.materialnumber</span>
                                    </li>
                                </ul>
                                @if (Model.emdList.EMDlisthistory != null && Model.emdList.EMDlisthistory.Where(x => x.tenderfeereferencenumber.Equals(item.tenderfeereferencenumber)).Any())
                                {
                                    <div class="m39-modal m39-modal--new j131-scrap-sales_modal" data-component="m39-modal" id="modal_true">
                                        <a data-trigger="true" class="button button--primary button--next button--very_small" href="@item.accountingdocumentnumber" target="_blank">@Translate.Text("SS_PH_ViewReceipt")</a>
                                        <button data-trigger="true" class="m39-modal__trigger hidden" id="_sm7xs93q5_trigger" type="button" aria-controls="_sm7xs93q5_content">@Translate.Text("SS_PH_ModelTrigger")</button>
                                        <div data-content="true" class="m39-modal__container" role="dialog" aria-expanded="true" id="_sm7xs93q5_content" aria-labelledby="_sm7xs93q5_trigger">
                                            <div class="m39-modal__dialog">
                                                <div class="m39-modal__header">
                                                    <div class="m39-modal__title">@Translate.Text("SS_PH_SalesOrder") @item.tenderfeereferencenumber</div>
                                                    <a data-close="true" class="m39-modal__button--close" id="_sm7xs93q5_close" aria-controls="_sm7xs93q5_content">@Translate.Text("TH.Close")</a>
                                                    <div class="m39-modal__subtitle">@Translate.Text("SS_PH_Receipts")</div>
                                                </div>
                                                <div class="m39-modal__content">
                                                    @foreach (emdListHistory i in Model.emdList.EMDlisthistory.Where(x => x.tenderfeereferencenumber.Equals(item.tenderfeereferencenumber)))
                                                    {
                                                        <div class="m39-modal__content--list">
                                                            <div class="m39-modal__content--list_text">
                                                                <div class="m39-modal__content--list_texthead">@Translate.Text("SS_PH_Receipts") @i.accountingdocumentnumber</div>
                                                                <div class="m39-modal__content--list_textdate">@Translate.Text("SS_PH_Amount") @i.amount @Translate.Text("AED")</div>
                                                            </div>
                                                            <a href="javascript:void(0)" data-trid="@(i.tenderfeereferencenumber)" data-adid="@(i.accountingdocumentnumber)" class="button button--primary button--small m39-modal__content--list_button emddocu-downloadbtn">@Translate.Text("SS_Download")</a>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        <div class="m39-modal__overlay" style="display: block;"> </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<div style="display:none">
    <form id="scrap-emdreciept-form" action="/api/sitecore/ScrapSale/DownloadEMDPaymentReceipt" method="post">
        @Html.AntiForgeryToken();
        <input type="text" name="tenderRefNumber" id="trno" class="trno" />
        <input type="text" name="emdAccDocNumber" id="eadno" class="eadno" />
    </form>
    <form id="scrap-sosreciept-form" action="/api/sitecore/ScrapSale/DownloadSalesOrderReceipt" method="post">
        @Html.AntiForgeryToken();
        <input type="text" name="fiscalYear" id="fyno" class="fyno" />
        <input type="text" name="companyCode" id="ccno" class="ccno" />
        <input type="text" name="accDocNumber" id="adno" class="adno" />
        <input type="text" name="salesDocNumber" id="sdno" class="sdno" />
    </form>
</div>
<script type="text/javascript">
    jQuery('.j131-scrap-sales_select').off('change.scrap').on('change.scrap', function () {
        if (jQuery(this).find(':selected').attr('data-transaction').length != 0) {
            var transaction = jQuery(this).find(':selected').attr('data-transaction');

            jQuery('.transaction-history[data-transaction]').each(function () {
                if (jQuery(this).attr('data-transaction') != transaction) {
                    jQuery(this).hide();
                } else {
                    jQuery(this).show();
                }
            });
        } else {
            jQuery('.transaction-history[data-transaction]').each(function () {
                jQuery(this).show();
            });
        };
    })

    setTimeout(function () {
        // Download sales order document
        $(".emddocu-downloadbtn").on("click", function () {
            // alert();
            $(".trno").val($(this).data("trid"))
            $(".eadno").val($(this).data("adid"))
            $("#scrap-emdreciept-form").submit();
        });

        // Payment sales order
        $(".sosdocu-downloadbtn").on("click", function () {
            // alert();
            $(".fyno").val($(this).data("fyid"))
            $(".ccno").val($(this).data("ccid"))
            $(".adno").val($(this).data("adnid"))
            $(".sdno").val($(this).data("sdnid"))
            $("#scrap-sosreciept-form").submit();
        });

    }, 500);

</script>