@using DEWAXP.Feature.SupplyManagement.Models.Complaints
@using Glass.Mapper.Sc.Web.Mvc
@using DEWAXP.Foundation.Content
@using Sitecore.Globalization
@using Sitecore.Mvc
@model ServiceComplaint
@*@{
	var page = (GenericPageWithIntro)ViewBag.Page;
}*@

<div class="box box--1">
	<div class="grid">
		@Html.Sitecore().Placeholder("j22/m26-page-title")
	</div>
</div>

<div class="m41-tabs-box">
	<div class="m41-tabs-box__tabs">
		<ul role="tablist" class="m41-tabs-box__tab-items">
			<li class="m41-tabs-box__tab-item">
				<a href="#"  class="m41-tabs-box__tab-link m41-tabs-box__tab-link--active">
					@Translate.Text("General")
				</a>
			</li>
			<li class="m41-tabs-box__tab-item">
				<a href="@ViewBag.BillingUrl"  class="m41-tabs-box__tab-link">
					@Translate.Text("Related to Billing")
				</a>
			</li>
		</ul>
	</div>
</div>

<div class="grid">
    <div class="grid__row">
        <div class="grid__column grid__column--12 grid__column--form text__content-copy--small">
            @Html.Glass().Editable(x => x.Intro)
        </div>
    </div>
    @Html.Partial("~/Views/Feature/CommonComponents/Shared/_SubmissionError.cshtml")
	<div class="grid__row nested">
		<div class="grid__column grid__column--12 grid__column--form">
            <form id="form-account-selector" action="/api/contactdetails/{id}" data-form="true" method="POST" form-skipvalidation="true">
                @Html.Sitecore().Placeholder("j1/m43-account-selector")
            </form>
		</div>
	</div>
	<div class="grid__row nested">
		<div class="grid__column grid__column--12 grid__column--form">
			@using (Html.BeginForm("MakeServiceComplaint", "Complaints", FormMethod.Post, new { @class = "form", data_form = "true", data_parsley_focus = "none", enctype = "multipart/form-data", @data_submit_validate = "enabled"}))
			{
				@Html.AntiForgeryToken()
				@Html.HiddenFor(x => x.AccountNumber, new { @id = "account-number" })

				<fieldset class="fieldset">
                    <legend class="legend-color">.</legend>
                    <div id="contact-details-placeholder" class="ajax-placeholder"></div>
					<br />
					<div class="form-field form-field--select form-field--select-single">
						<label for="form-field-complaint-type" class="form-field__label">
							@Translate.Text("Complaint Type")
							<span class="form-field__label-required aria-only">(@Translate.Text("Required"))</span>
						</label>
						<span class="form-field__input-wrapper form-field__input-wrapper--select">
							@Html.DropDownListFor(x => x.ComplaintType, (IEnumerable<SelectListItem>)ViewBag.Complaints, Translate.Text("Select"), new { @aria_describedby = "description-for-2dyij8xgk", @required = "", data_parsley_error_message = @Translate.Text("Please enter a value"), data_parsley_errors_container = "#description-for-2dyij8xgk", @class = "form-field__input form-field__input--select form-field__input--select-full", @id = "form-field-complaint-type" })
						</span>
						<div id="description-for-complaint-type" class="form-field__messages"></div>
					</div>
					
					<div class="form-field form-field--text ">
						<label for="form-field-mobile" class="form-field__label">
							@Translate.Text("Mobile Number")
							<span class="form-field__label-optional">(@Translate.Text("optional"))</span>
						</label>
						<span class="form-field__input-wrapper form-field__input-wrapper--prefixed form-field__input-wrapper--mobile-number">
							<input class="form-field__input form-field__input--text form-field__input--prefixed"
								   id="form-field-mobile" name="mobile_number" type="tel" placeholder="@Translate.Text("Enter UAE mobile number")"
								   aria-describedby="description-for-mobile" data-parsley-error-message="@Translate.Text("Please enter a valid UAE mobile number")"
							       data-parsley-errors-container="#description-for-mobile" 
							       data-parsley-mobile_number="" data-parsley-id="14" data-parsley-type="digits"
                                   value="@Model.MobileNumber">
						</span>
						<div id="description-for-mobile" class="form-field__messages">
						</div>
					</div>
					

					<div class="form-field">
						<div class="form-field__checkbox ">
							<label>
								<input class="form-field__input form-field__input--checkbox" id="form-field-location-coordinates" name="LocationCoordinates" type="checkbox" value="false" aria-describedby="description-for-sendcoords" checked="@Model.LocationCoordinates">
								<span class="form-field__fakecheckbox focus-enabled">@Translate.Text("Send location coordinates")</span>
							</label>
						</div>
						<div id="description-for-sendcoords" class="form-field__messages">
						</div>
						<input type="hidden" name="xGPS" value="" id="xgps" />
						<input type="hidden" name="yGPS" value="" id="ygps" />
					</div>

					<div class="form-field form-field--text form-field--textarea">
						<label for="form-field-desc" class="form-field__label">
							@Translate.Text("Description")
							<span class="form-field__label-required aria-only">(@Translate.Text("Required"))</span>
						</label>
						<span class="form-field__input-wrapper">
							@Html.TextAreaFor(x => x.Description,
								new
								{
									@class = "form-field__input form-field__input--text form-field__input--textarea",
									@id = "form-field-desc", @maxlength = "250",
									@data_textarea = "desc",
                                    @placeholder = @Translate.Text(DictionaryKeys.Global.EnterYourMessage),
									@required = "",
                                    @data_parsley_error_message = @Translate.Text(DictionaryKeys.Global.EnterDescription),
									@data_parsley_errors_container = "#description-for-desc",
									@aria_describedby = "description-for-desc"
								})
						</span>
						<div id="description-for-desc" class="form-field__messages">
							<p class="form-field__charcount">@Translate.Text("Max") <span data-charcount="desc">0</span>/250 @Translate.Text("Characters")</p>
						</div>
					</div>

					<div class="form-field form-field--upload">
						<div class="form-field__input-wrapper">
							<div class="form-field__preview-wrapper">
								<img src="/images/preview@2x.png"
								     data-src="/images/preview@2x.png"
								     data-success="/images/upload_success@2x.png"
								     class="form-field__preview"
								     aria-hidden="true"
								     role="presentation"
								     alt=""
								     data-uploader-image="attachment"/>
							</div>
							<div class="form-field__uploader-details">
								<label for="form-field-attachment" class="form-field__label">
									<strong class="form-field__label-description inline-block">@Translate.Text("Attachment")</strong>
									<span class="form-field__label-optional">(@Translate.Text("optional"))</span>
								</label>
							    <div>
							        <label for="form-field-attachment">
								        <input
									        class="form-field__input form-field__input--upload"
									        id="form-field-attachment"
									        name="File"
									        type="file"
									        aria-describedby="description-for-attachment"
									        data-parsley-errors-container="#errors-for-attachment"
									        data-uploader-field="attachment"
									        accept="image/png,image/x-png,image/jpeg,image/jpg,image/bmp,image/gif,application/pdf,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
									        data-parsley-id="22"
									        aria-invalid="false"/>
							            <span class="button button--primary button--next button--small focus-enabled">@Translate.Text("Choose")</span>
							        </label>
							    </div>
                                <p class="form-field__input--upload-filename" data-uploader-filename="attachment"></p>
								<p><button class="button button--text button--remove hidden" data-uploader-remove="attachment">@Translate.Text("Remove")</button></p>
							</div>
						</div>
						<div id="description-for-attachment" class="form-field__messages">
							<div id="errors-for-attachment"></div>
							<p class="form-field__description">
								@Translate.Text("Max Size Copy")
							</p>
						</div>
					</div>
				</fieldset>
				<div class="form-field__button">
					<button type="submit" class="button button--primary button--next" data-submission-text="@Translate.Text("Submitting")...">@Translate.Text("Submit")</button>
				</div>
			}
		</div>
	</div>
</div>

<script id="contact-details-template" type="text/x-handlebars-template">
	<div class="form-field form-field--text">
		<label for="form-field-accountno" class="form-field__label form-field__label--readonly">
			@Translate.Text(DictionaryKeys.Global.Account.ContractAccountNumber)
		</label>
		<span class="form-field__input-wrapper form-field__input-wrapper--readonly">
			<input class="form-field__input form-field__input--readonly" readonly
						 id="form-field-accountno"
						 name="contact_account_number"
						 type="text"
						 value="{{accountNumber}}" />
		</span>
	</div>
	<div class="form-field form-field--text">
		<label for="form-field-mobile" class="form-field__label form-field__label--readonly">
			@Translate.Text("Mobile Number")
		</label>
		<span class="form-field__input-wrapper form-field__input-wrapper--readonly">
			<input class="form-field__input form-field__input--readonly" readonly
						 id="form-field-mobile"
						 name="MobileNumber"
						 type="text"
						 value="{{mobile}}" />
		</span>
	</div>
	<div class="form-field form-field--text">
		<label for="form-field-email" class="form-field__label form-field__label--readonly">
			@Translate.Text("Email Address")
		</label>
		<span class="form-field__input-wrapper form-field__input-wrapper--readonly">
			<input class="form-field__input form-field__input--readonly" readonly
				id="form-field-email"
				name="email_addressr"
				type="email"
				value="{{email}}" />
		</span>
	</div>
</script>

<script>
    docReady(function () {
        jQuery('.button').removeAttr('disabled');
        jQuery('#form-account-selector').off("submit").submit(handleAccountSelection);
		jQuery('#form-account-selector').submit();
		
		jQuery(function ($) {
			var coords;

			var getLocation = function() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(showPosition);
					$(document).click('.form-field__fakecheckbox', checkboxChangeHandler);
				}
			};

			var showPosition = function(position) {
				coords = position.coords;
				$("#ygps").val(position.coords.latitude);
				$("#xgps").val(position.coords.longitude);
			};

			var checkboxChangeHandler = function() {
				setTimeout(checkValue, 2000);
			};

			var checkValue = function() {
				var $this = jQuery("#form-field-location-coordinates");
				if ($this.is(":checked")) {
					$this.val("true");
				} else {
					$this.val("false");
				}
			};

			getLocation();
		});
	});

	function handleAccountSelection(e) {
		var accountNumber = jQuery(e.target).find('input[name="SelectedAccountNumber"]:checked').val();
		if (accountNumber) {
			jQuery('#contact-details-placeholder').empty();

			var url = jQuery(e.target).attr('action').replace("{id}", accountNumber);
			jQuery.ajax(url, {
				beforeSend: function () {
					window.attachSpinner('#contact-details-placeholder', { zIndex: 1, minHeight: 90 });
				},
				complete: function () {
					window.detachSpinner('#contact-details-placeholder');
				},
				dataType: 'json',
                method: 'GET',
                success:function(response) {
                    var context = {
                        mobile: response.Mobile,
                        email: response.Email,
                        accountNumber: response.AccountNumber
                    };
                    render(context);
                    jQuery("#account-number").val(response.AccountNumber);
                },
			});
		}
		return false;
	}

	function render(context) {
		var markup = jQuery('#contact-details-template').html();
		var template = Handlebars.compile(markup);

		var rendering = template(context);
		jQuery('#contact-details-placeholder').html(rendering);
		jQuery(".ajax-loader-overlay").remove();
		window.initComponents('contact-details-placeholder');
	}
</script>

<script src="~/scripts/External/nml/form-submit-validate.js"></script>