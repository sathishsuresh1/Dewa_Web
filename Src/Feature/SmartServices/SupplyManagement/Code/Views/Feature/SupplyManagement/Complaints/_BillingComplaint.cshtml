@using DEWAXP.Foundation.Integration.Enums
@using DEWAXP.Foundation.Helpers
@using DEWAXP.Foundation.Content
@using DEWAXP.Feature.SupplyManagement.Models.Complaints
@using Glass.Mapper.Sc.Web.Mvc
@using Sitecore.Globalization
@using Sitecore.Mvc
@model BillingComplaint
@*@{
	var page = (GenericPageWithIntro)ViewBag.Page;
}*@

<div class="box box--1">
	<div class="grid">
		@Html.Sitecore().Placeholder("j24/m26-page-title")
	</div>
</div>

<div class="m41-tabs-box">
	<div class="m41-tabs-box__tabs">
		<ul role="tablist" class="m41-tabs-box__tab-items">
			<li class="m41-tabs-box__tab-item">
				<a href="@LinkHelper.GetItemUrl(SitecoreItemIdentifiers.J22_SERVICE_COMPLAINT)"  class="m41-tabs-box__tab-link">@Translate.Text("General")</a>
			</li>
			<li class="m41-tabs-box__tab-item">
				<a href="#"  class="m41-tabs-box__tab-link m41-tabs-box__tab-link--active">@Translate.Text("Related to Billing")</a>
			</li>
		</ul>
	</div>
</div>

<div class="grid">
	<div class="grid__row">
		<div class="grid__column grid__column--12 grid__column--form text__content-copy--small">
			@*@Html.Glass().Editable(page, x => x.Intro)*@
            @Html.Glass().Editable(x => x.Intro)
		</div>
	</div>
    @Html.Partial("~/Views/Feature/CommonComponents/Shared/_SubmissionError.cshtml")
	<div class="grid__row nested">
		<div class="grid__column grid__column--12 grid__column--form">
            <form id="form-account-selector" action="/api/contactdetails/{id}" data-form="true" method="POST" form-skipvalidation="true">
                @Html.Sitecore().Placeholder("j1/m43-account-selector")
            </form>
		</div>
	</div>
	
	<div class="grid__row nested">
		<div class="grid__column grid__column--12 grid__column--form">
			@using (Html.BeginForm("MakeBillingComplaint", "Complaints", FormMethod.Post, new { id = "form-billing-complaint", @class = "form", data_form = "true", data_parsley_focus = "none", enctype = "multipart/form-data", @data_submit_validate = "enabled" }))
			{
				@Html.AntiForgeryToken()
				@Html.HiddenFor(x => x.AccountNumber)
				<fieldset class="fieldset">
                    <legend class="legend-color">.</legend>
					<div class="form-field form-field--text">
						<label for="form-field-mobile" class="form-field__label">
							@Translate.Text("Mobile number")<span class="form-field__label-required aria-only">(@Translate.Text("required"))</span>
						</label>
						<span class="form-field__input-wrapper form-field__input-wrapper--prefixed form-field__input-wrapper--mobile-number">
                            <input type="tel"
                                   id="form-field-mobile"
                                   name="MobileNumber"
                                   @*aria-required="true"*@
                                   aria-describedby="description-for-mobile"
                                   required="required"
                                   placeholder="@Translate.Text("Mobile number placeholder")"
                                   data-parsley-error-message="@Translate.Text("Please enter a valid UAE mobile number")"
                                   data-parsley-type="digits"
                                   data-parsley-trigger="focusout"
                                   data-parsley-mobile_number=""
                                   data-parsley-errors-container="#description-for-mobile"
                                   class="form-field__input form-field__input--text form-field__input--prefixed ajax-input"
                                   value="@Model.MobileNumber" />
						</span>
						<div id="description-for-mobile" class="form-field__messages">
							@Html.ValidationMessageFor(x => x.MobileNumber, string.Empty, new { @class = "parsley-errors-list" })
						</div>
					</div>

					<div class="form-field form-field--text">
						<label for="form-field-email" class="form-field__label">
							@Translate.Text("Email address")<span class="form-field__label-required aria-only">(@Translate.Text("required"))</span>
						</label>
						<span class="form-field__input-wrapper">
                            <input type="email"
                                   id="form-field-email"
                                   name="EmailAddress"
                                   @*aria-required="true"*@
                                   required="required"
                                   placeholder="@Translate.Text("Email address placeholder")"
                                   aria-describedby="description-for-email"
                                   data-parsley-error-message="@Translate.Text("Please enter a valid email address")"
                                   data-parsley-trigger="focusout"
                                   data-parsley-errors-container="#description-for-email"
                                   class="form-field__input form-field__input--text ajax-input"
                                   value="@Model.EmailAddress" />
						</span>
						<div id="description-for-email" class="form-field__messages">
							@Html.ValidationMessageFor(x => x.EmailAddress, string.Empty, new {@class = "parsley-errors-list"})
						</div>
					</div>

					<div class="form-field form-field--select form-field--select-single">
						<label for="form-field-category" class="form-field__label">
							@Translate.Text("Request Category")
							<span class="form-field__label-required aria-only">(@Translate.Text("Required"))</span>
						</label>
						<span class="form-field__input-wrapper form-field__input-wrapper--select">
							<select class="form-field__input form-field__input--select form-field__input--select-full"
									id="form-field-category"
									name="RequestCategory"
									aria-describedby="description-for-category"
									@*aria-required="true"*@
                                    required="required"
									data-parsley-error-message="@Translate.Text("generic validation message")"
									data-parsley-errors-container="#description-for-category"
									aria-describedby="description-for-category">
								<option value="" selected>@Translate.Text("Select")</option>
								<option value="@ComplaintPriority.High">@Translate.Text("High Consumption")</option>
								<option value="@ComplaintPriority.Low">@Translate.Text("Low Consumption")</option>
								<option value="@ComplaintPriority.Nil">@Translate.Text("Nil Consumption")</option>
							</select>
						</span>
						<div id="description-for-category" class="form-field__messages"></div>
					</div>

					<div class="form-field form-field--select form-field--select-single">
						<label for="form-field-complaint-type" class="form-field__label">
							@Translate.Text("Complaint Type")
							<span class="form-field__label-required aria-only">(@Translate.Text("Required"))</span>
						</label>
						<span class="form-field__input-wrapper form-field__input-wrapper--select">
							@*Html.DropDownListFor(x => x.ComplaintType, (IEnumerable<SelectListItem>)ViewBag.Complaints, "Select", new { @aria_describedby = "description-for-complaint-type", aria_required = "true", @required = "", data_parsley_error_message = "Please enter a value", data_parsley_errors_container = "#description-for-complaint-type", @class = "form-field__input form-field__input--select form-field__input--select-full", @id = "form-field-complaint-type" })*@
                            <select class="form-field__input form-field__input--select form-field__input--select-full"
                                    id="form-field-complaint-type"
                                    name="ComplaintType"
                                    aria-describedby="description-for-complaint-type"
                                    @*aria-required="true"*@
                                    required="required"
                                    data-parsley-error-message="@Translate.Text("generic validation message")"
                                    data-parsley-errors-container="#description-for-complaint-type">
                                <option value="" selected>@Translate.Text("Select")</option>
                                <option value="@MunicipalService.Electricity">@Translate.Text("Electricity")</option>
                                <option value="@MunicipalService.Water">@Translate.Text("Water")</option>
                            </select>
						</span>
						<div id="description-for-complaint-type" class="form-field__messages"></div>
					</div>

					<div class="form-field form-field--text form-field--textarea">
						<label for="form-field-complaint-desc" class="form-field__label">
							@Translate.Text("Description")
							<span class="form-field__label-required aria-only">(@Translate.Text("Required"))</span>
						</label>
						<span class="form-field__input-wrapper">
							<textarea id="form-field-complaint-desc"
										name="Description"
										class="form-field__input form-field__input--text form-field__input--textarea"
										maxlength="250"
										placeholder="@Translate.Text(DictionaryKeys.Global.EnterYourMessage)"
										data-textarea="complaint-desc"
										@*aria-required="true"*@
										aria-describedby="description-for-complaint-desc"
										required="required"
										data-parsley-error-message="@Translate.Text(DictionaryKeys.Global.EnterDescription)"
										data-parsley-errors-container="#description-for-complaint-desc"
										data-parsley-trigger="focusout">@Model.Description</textarea>
						</span>

						<div id="description-for-complaint-desc" class="form-field__messages">
							<p class="form-field__charcount">@Translate.Text("Max") <span data-charcount="complaint-desc">0</span>/250 @Translate.Text("Characters")</p>
						</div>
					</div>

					<div class="form-field form-field--upload">
						<div class="form-field__input-wrapper">
							<div class="form-field__preview-wrapper">
								<img src="/images/preview@2x.png" data-src="/images/preview@2x.png" data-success="/images/upload_success@2x.png" class="form-field__preview" aria-hidden="true" role="presentation" alt="" data-uploader-image="attachment" />
							</div>

							<div class="form-field__uploader-details">
								<label for="form-field-attachment" class="form-field__label">
									<strong class="form-field__label-description inline-block">@Translate.Text("Attachment")</strong>
									<span class="form-field__label-optional">(@Translate.Text("optional"))</span>
								</label>

								<div>
									<label>
										<input
											class="form-field__input form-field__input--upload"
											id="form-field-attachment"
											name="ComplaintAttachmentUploader"
											type="file"
											aria-describedby="description-for-attachment"
											data-parsley-errors-container="#errors-for-attachment"
											data-uploader-field="attachment" 
											accept="image/png,image/x-png,image/jpeg,image/jpg,image/bmp,image/gif,application/pdf,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
										<span class="button button--primary button--next button--small focus-enabled">@Translate.Text("Choose")</span>
									</label>
								</div>

								<p class="form-field__input--upload-filename" data-uploader-filename="attachment"></p>
								<p>
									<button class="button button--text button--remove hidden" data-uploader-remove="attachment">@Translate.Text("Remove")</button>
								</p>
							</div>
						</div>

						<div id="description-for-attachment" class="form-field__messages">
							<div id="errors-for-attachment"></div>
							<p class="form-field__description">@Translate.Text(DictionaryKeys.MoveIn.MaxFileSize)</p>
						</div>
					</div>

					<div class="form-field form-field--toggles">
						<div class="form-field__checkbox  last">
							<label>
								<input class="form-field__input form-field__input--checkbox" id="form-field-checkbox_1_1" name="AgreedToPayment" type="checkbox" value="true" aria-describedby="description-for-accept-terms" required="" data-parsley-error-message="@Translate.Text("You must accept terms and conditions to continue")" data-parsley-errors-container="#description-for-accept-terms" data-parsley-multiple="checkbox_1_1" data-parsley-id="23">
								<span class="form-field__fakecheckbox focus-enabled">@Translate.Text("Payment Agreement Copy")</span>
							</label>
						</div>
						<div id="description-for-accept-terms" class="form-field__messages"></div>
						<input type="hidden" name="AgreedToPayment" value="false" />
					</div>

					<div class="form-field__button">
						<button class="button button--primary button--next" type="submit" data-submission-text="@Translate.Text("Submitting")...">@Translate.Text("Submit")</button>
					</div>
				</fieldset>
			}
		</div>
	</div>
</div>

<script>
    docReady(function () {
        jQuery('.button').removeAttr('disabled');
        jQuery('#form-account-selector').off("submit").submit(handleAccountSelection);
		jQuery('#form-account-selector').submit();
	});

	function handleAccountSelection(e) {
		var accountNumber = jQuery(e.target).find('input[name="SelectedAccountNumber"]:checked').val();
		if (accountNumber) {
			var url = jQuery(e.target).attr('action').replace("{id}", accountNumber);
			jQuery.ajax(url, {
				beforeSend: function () {
					jQuery('.ajax-input').attr('disabled', 'disabled').closest('.form-field').addClass('form-field--disabled');
					//window.attachSpinner('#contact-details-placeholder', { zIndex: 1, minHeight: 90, bgColor: '#fff' });
				},
				complete: function () {
					jQuery('.ajax-input').removeAttr('disabled').closest('.form-field').removeClass('form-field--disabled');
					//window.detachSpinner('#contact-details-placeholder');
				},
				dataType: 'json',
                method: 'GET',
                success: function(response) {
                    jQuery('input[name="MobileNumber"]').val(response.Mobile[0] === '0' ? response.Mobile.substring(1) : response.Mobile);
                    jQuery('input[name="EmailAddress"]').val(response.Email);
                    jQuery('input[name="AccountNumber"]').val(response.AccountNumber);
                }
			});
		}
		return false;
	}
</script>

<script src="~/scripts/External/nml/form-submit-validate.js"></script>