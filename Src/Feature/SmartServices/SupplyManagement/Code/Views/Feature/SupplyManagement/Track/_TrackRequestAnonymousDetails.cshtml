@using DEWAXP.Foundation.Helpers
@using Sitecore.Globalization
@using Sitecore.Mvc
@using Glass.Mapper.Sc.Web.Mvc
@using Sitecore.Mvc.Configuration
@using DEWAXP.Foundation.Content
@model DEWAXP.Feature.SupplyManagement.Models.Track.TrackRequestAnonymous


<div class="j105-drrg">
    <div class="m66-preloader j105-drrg--loader hidden">
        <div class="grid">
            <div class="grid__row">
                <div class="grid__column grid__column--12">
                    <h2 class="text__section-subtitle">@Translate.Text("J100.Pleasewait")</h2>
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="grid j141-tracking-anonymous" data-journey="j141-tracking-anonymous">
    <div class="grid__row">
        <div class="grid__column grid__column--12">
            <a href="@LinkHelper.GetItemUrl(SitecoreItemIdentifiers.TRACK_REQUEST_ANONYMOUS)" class="j120-smart-response--button">@Translate.Text("TRA_Back")</a>
            @using (Html.BeginRouteForm(MvcSettings.SitecoreRouteName, FormMethod.Post, new { @class = "form form--inline", @id = "TrackRequestAnonymous", @data_form = "true", @novalidate = string.Empty }))
            {
                @Html.Sitecore().FormHandler()
                @Html.AntiForgeryToken()
                @Html.Partial("~/Views/Feature/CommonComponents/Shared/_SubmissionError.cshtml")
                if (Model != null)
                {
                    <legend class="j141-tracking--legend">
                        @Translate.Text("TRA_TrackRequests")
                    </legend>

                    <div class="j141-tracking--sublegend">
                        @((!string.IsNullOrWhiteSpace(Model.Flag) && Model.Flag.ToLower().Equals("a")) ? "" + Translate.Text("TRA_Account") + "" : "" + Translate.Text("TRA_Reference") + "")  @Model.AccountOrRequestNumber
                    </div>

                    <div class="form-field j141-tracking--radio">
                        <fieldset class="fieldset">
                            <legend class="legend-color">.</legend>
                            @if (!string.IsNullOrEmpty(Model.MaskedEmailAddress))
                            {
                                <div class="form-field__radio ">
                                    <label>
                                        <input class="form-field__input form-field__input--radio"
                                               id="SelectedOptions"
                                               aria-label="SelectedOptions"
                                               name="SelectedOptions"
                                               type="radio"
                                               value="email"
                                               aria-describedby="description-for-mwkcis1ps"
                                               data-parsley-errors-container="#description-for-mwkcis1ps"
                                               checked>

                                        <span class="form-field__fakeradio focus-enabled">
                                            <strong>@Translate.Text("TRA_Email")</strong> <strong>@Model.MaskedEmailAddress</strong>
                                        </span>
                                        <br>
                                        <span class="form-field__description align-radio-desc">
                                            @Translate.Text("TRA_EmailDescription")
                                        </span>
                                    </label>
                                    <input type="hidden" value="" id="verify-mail" name="">
                                    <div class="form-field form-field--text form-field--subRadio">
                                        <label for="form-field-emailaddress" class="form-field__label">
                                        </label>
                                        <span class="form-field__input-wrapper">
                                            <input class="form-field__input form-field__input--text"
                                                   id="form-field-emailaddress"
                                                   name="EmailAddress"
                                                   type="email"
                                                   maxlength="60"
                                                   placeholder="@Translate.Text("TRA_VerifyEmail")"
                                                   data-parsley-error-message="@Translate.Text("TRA_Emailerrormessage")"
                                                   aria-describedby="description-for-emailaddress"
                                                   data-parsley-errors-container="#description-for-emailaddress"
                                                  data-parsley-trigger="focusout"
                                                   data-parsley-id="8">
                                        </span>
                                        <div id="description-for-emailaddress" class="form-field__messages">
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.MaskedMobileNumber))
                            {
                                <div class="form-field__radio">
                                    <label>
                                        <input class="form-field__input form-field__input--radio"
                                               id="SelectedOptions"
                                               aria-label="SelectedOptions"
                                               name="SelectedOptions"
                                               type="radio"
                                               value="mobile"
                                               aria-describedby="description-for-maskmobilenumber"
                                               data-parsley-errors-container="#description-for-maskmobilenumber"
                                               @(string.IsNullOrEmpty(Model.MaskedEmailAddress) ? "checked" : "")>
                                        <span class="form-field__fakeradio focus-enabled">
                                            <strong>@Translate.Text("TRA_Phone")</strong> <strong dir="ltr">@Model.MaskedMobileNumber</strong>
                                        </span>
                                        <br>
                                        <span class="form-field__description align-radio-desc">
                                            @Translate.Text("TRA_MobileDescription")
                                        </span>
                                    </label>
                                    <input type="hidden" value="" id="verify-contact" name="">
                                    <div class="form-field form-field--text form-field--subRadio">
                                        <label for="form-field-mobilenumber" class="form-field__label">
                                        </label>
                                        <span class="form-field__input-wrapper form-field__input-wrapper--prefixed form-field__input-wrapper--mobile-number">
                                            <input class="form-field__input form-field__input--text form-field__input--prefixed"
                                                   id="form-field-mobilenumber"
                                                   name="MobileNumber"
                                                   type="tel"
                                                   placeholder="@Translate.Text("TRA_VerifyMobile")"
                                                   aria-describedby="description-for-mobilenumber"
                                                   data-parsley-errors-container="#description-for-mobilenumber"
                                                   data-parsley-required-message="@Translate.Text("TRA_MobileNumberErrorMessageRequired")"
                                                   data-parsley-mobile_number=""
                                                   data-parsley-mobile_number-message="@Translate.Text("TRA_MobileNumberErrorMessageInvalid")"
                                                  data-parsley-trigger="focusout"
                                                   data-parsley-id="14">
                                        </span>
                                        <div id="description-for-mobilenumber" class="form-field__messages">
                                        </div>
                                    </div>
                                </div>
                            }

                        </fieldset>
                    </div>

                    <div class="form-field__button mt0">
                        <button class="button button--primary" type="submit" id="btnSearch">@Translate.Text("TRA_ViewStatus")</button>
                    </div>
                }
            }
        </div>
    </div>
</div>
<script type="text/javascript">
    //jQuery('#TrackRequestAnonymous').submit(function (e) {
    //    e.preventDefault();
    //    if (jQuery("#TrackRequestAnonymous").parsley().validate()) {
    //        jQuery('.j105-drrg--loader').show();
    //        jQuery('.j105-drrg--loader').css('top', $(window).scrollTop());
    //        jQuery('body').removeClass('unscrollable').addClass('unscrollable');
    //    }
    //    return false;
    //});
    docReady(function () {
        jQuery('#btnSearch').on('click', (verifyUser));
        var $Email = jQuery("#form-field-emailaddress");
        var $Mobile = jQuery("#form-field-mobilenumber");
        var $submitBtn = jQuery("#btnSearch");
        var errEmailaddress = jQuery('#description-for-emailaddress');
        var errMobileNumber = jQuery('#description-for-mobilenumber');
        //$submitBtn.attr('disabled', true);
        var mskEmail = '@Model.MaskedEmailAddress';
        var mskMobile = '@Model.MaskedMobileNumber';
        if (mskEmail!="") {
            jQuery("#form-field-mobilenumber").attr("disabled", true);
        }
        //$Email.on('focusout', function () {
        //    if (jQuery('input[name="SelectedOptions"]:checked').val() == "email") {
        //        if (jQuery('#description-for-emailaddress').html() == '')
        //            VerifyEmailMobile("E");
        //    }
        //});
        //$Mobile.on('focusout', function () {
        //    if (jQuery('input[name="SelectedOptions"]:checked').val() == "mobile") {
        //        VerifyEmailMobile("M");
        //    }
        //});
        function verifyUser(e) {
           if (jQuery("#TrackRequestAnonymous").parsley().validate()) {
                e.preventDefault();
                e.stopPropagation();
                if (jQuery('input[name="SelectedOptions"]:checked').val() == "email") {
                    VerifyEmailMobile("E");
                }
                if (jQuery('input[name="SelectedOptions"]:checked').val() == "mobile") {
                    VerifyEmailMobile("M");
                }
            }
        }
        jQuery('input[name="SelectedOptions"]').change(function () {
            if (this.value == 'email') {
                errMobileNumber.html('');
                jQuery("#form-field-mobilenumber").val('');
                jQuery("#form-field-mobilenumber").attr("disabled", "disabled");
                jQuery("#form-field-emailaddress").removeAttr("disabled");
                jQuery("#form-field-mobilenumber").parent('span').removeClass("form-field__input-wrapper--validated");
                jQuery("#form-field-mobilenumber").parent('span').removeClass("form-field__input-wrapper--error");
            }
            else if (this.value == 'mobile') {
                errEmailaddress.html('');
                jQuery("#form-field-emailaddress").val('');
                jQuery("#form-field-emailaddress").attr("disabled", "disabled");
                jQuery("#form-field-mobilenumber").removeAttr("disabled");
                jQuery("#form-field-emailaddress").parent('span').removeClass("form-field__input-wrapper--validated");
                jQuery("#form-field-emailaddress").parent('span').removeClass("form-field__input-wrapper--error");
            }
        });
        function VerifyEmailMobile(iv_type) {
            var form = jQuery("#TrackRequestAnonymous");
            var token = $('input[name="__RequestVerificationToken"]', form).val();
            var url = "/api/sitecore/Track/VerifyEmailMobile";
            jQuery.ajax({
                url: url,
                traditional: true,
                dataType: 'json',
                type: 'POST',
                data: {
                    __RequestVerificationToken: token,
                    ivtype: iv_type,
                    mobile: $Mobile.val(),
                    email: $Email.val(),
                },
                beforeSend: function () {
                    jQuery('.j105-drrg--loader').show();
                    jQuery('.j105-drrg--loader').css('top', $(window).scrollTop());
                    $('body').removeClass('unscrollable').addClass('unscrollable');
                    $submitBtn.attr('disabled', true);
                },
                complete: function () {
                  
                },
                success: function (response) {
                    if (response != null) {
                        if (response.errorCode != "000") {
                            valid = false;
                            switch (iv_type) {
                                case "E":
                                    errEmailaddress.html('');

                                    errEmailaddress.html('<ul class="parsley-errors-list filled"><li class="parsley-custom-error-message">' + response.Message + '</li></ul>');
                                    jQuery("#form-field-emailaddress").removeClass("parsley-success");
                                    jQuery("#form-field-emailaddress").addClass("form-field__input--error parsley-error");
                                    jQuery("#form-field-emailaddress").parent('span').removeClass("form-field__input-wrapper--validated");
                                    jQuery("#form-field-emailaddress").parent('span').addClass("form-field__input-wrapper--error");

                                    errMobileNumber.html('');
                                    jQuery("#form-field-mobilenumber").val('');

                                    break;
                                case "M":
                                    errMobileNumber.html('');
                                    errEmailaddress.html('');
                                    jQuery("#form-field-emailaddress").val('');
                                    errMobileNumber.html('<ul class="parsley-errors-list filled"><li class="parsley-custom-error-message">' + response.Message + '</li></ul>');
                                    jQuery("#form-field-mobilenumber").removeClass("parsley-success");
                                    jQuery("#form-field-mobilenumber").addClass("form-field__input--error parsley-error");
                                    jQuery("#form-field-mobilenumber").parent('span').removeClass("form-field__input-wrapper--validated");
                                    jQuery("#form-field-mobilenumber").parent('span').addClass("form-field__input-wrapper--error");
                                    break;
                                default:
                            }
                            jQuery('.j105-drrg--loader').hide();
                            $('body').removeClass('unscrollable');
                            $submitBtn.attr('disabled', false);
                        }
                        else {
                            valid = true;
                            errEmailaddress.html('');
                            errMobileNumber.html('');
                            //
                            $submitBtn.submit();
                        }
                    }
                  
                },
                error: function (response) {
                    console.log(response);
                }
            });
        }
    });
</script>